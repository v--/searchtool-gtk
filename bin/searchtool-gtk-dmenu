#!/usr/bin/env bash

which gdbus jq > /dev/null || exit 1

if test "$#" -ne 1;
then
    echo 'Usage: searchtool-gtk-dmenu <mode_name>' > /dev/stderr
    exit 1
fi

# We will now construct a JSON array from a newline-separated list of strings coming from STDIN
# https://stackoverflow.com/a/44477891
items="$(cat | jq --null-input --raw-input --compact-output '[inputs]')"

output="$(gdbus call \
    --session \
    --dest net.ivasilev.SearchToolGTK \
    --object-path /net/ivasilev/SearchToolGTK \
    --method net.ivasilev.SearchToolGTK.Pick \
    "$1" "$items")"

# Split "(true, 'value')" into "true" and "value"
is_selected="$(echo "${output:1:-1}" | cut --delimiter=',' --fields=1)"
value="$(echo "${output:0:-2}" | cut --delimiter=',' --fields=2 | tail -c +3)"

case $is_selected in
  true )
    printf '%b\n' "$value"
    ;;

  false )
    false
    ;;
esac
